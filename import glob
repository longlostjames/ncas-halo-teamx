import glob
import pandas as pd
import xarray as xr
from halo_look import read_hpl

# Read all Stare_18_*.hpl files
hpl_files = sorted(glob.glob("Stare_18_*.hpl"))

# Optionally, read all Background*.txt files (if needed)
background_files = sorted(glob.glob("Background*.txt"))
background_data = [pd.read_csv(f, delim_whitespace=True) for f in background_files]

# Read and combine all HPL files
dfs = []
for f in hpl_files:
    df, metadata = read_hpl(f)  # Adjust if your read_hpl returns differently
    df['source_file'] = f
    dfs.append(df)

# Concatenate all dataframes
all_data = pd.concat(dfs, ignore_index=True)

# Convert to xarray Dataset
ds = xr.Dataset.from_dataframe(all_data)

# Optionally, add metadata from backgrounds or HPLs
# ds.attrs.update(...)

# Save to NetCDF
ds.to_netcdf("out.nc")